<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>RxJava-操作符自定义理解 | Bevis技术小站</title><meta name="description" content="RxJava-操作符自定义理解"><meta name="keywords" content="Android,RxJava"><meta name="author" content="Bevis"><meta name="copyright" content="Bevis"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="RxJava-操作符自定义理解"><meta name="twitter:description" content="RxJava-操作符自定义理解"><meta name="twitter:image" content="http://yoursite.com/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="RxJava-操作符自定义理解"><meta property="og:url" content="http://yoursite.com/2019/07/01/RxJava-%E6%93%8D%E4%BD%9C%E7%AC%A6%E8%87%AA%E5%AE%9A%E4%B9%89%E7%90%86%E8%A7%A3/"><meta property="og:site_name" content="Bevis技术小站"><meta property="og:description" content="RxJava-操作符自定义理解"><meta property="og:image" content="http://yoursite.com/img/post.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2019/07/01/RxJava-%E6%93%8D%E4%BD%9C%E7%AC%A6%E8%87%AA%E5%AE%9A%E4%B9%89%E7%90%86%E8%A7%A3/"><link rel="prev" title="BUG-Paging框架PageListAdapter与BaseRecyclerViewAdapterHelper框架BaseQuickAdapter冲突" href="http://yoursite.com/2019/11/28/BUG-Paging%E6%A1%86%E6%9E%B6PageListAdapter%E4%B8%8EBaseRecyclerViewAdapterHelper%E6%A1%86%E6%9E%B6BaseQuickAdapter%E5%86%B2%E7%AA%81/"><link rel="next" title="Glide-缓存机制" href="http://yoursite.com/2019/06/24/Glide-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Bevis技术小站" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">36</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">20</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#原理分析"><span class="toc-number">1.</span> <span class="toc-text">原理分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#简单自定义操作"><span class="toc-number">2.</span> <span class="toc-text">简单自定义操作</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#以Map为例子"><span class="toc-number">2.1.</span> <span class="toc-text">以Map为例子</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义协程操作"><span class="toc-number">2.2.</span> <span class="toc-text">自定义协程操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sbscribeOn"><span class="toc-number">2.2.1.</span> <span class="toc-text">sbscribeOn</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Bevis技术小站</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">RxJava-操作符自定义理解</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2019-07-01 20:24:46"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-07-01</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h1 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h1><p>以<code>just</code>最简单的调用链作为例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(1,2,3).subscribe &#123; </span><br><span class="line">          Log.i(&quot;Logger&quot;, &quot;next output &gt;&gt;  $it&quot;)</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>该例子只参与创建和订阅流程，具体时序图：</p>
<p><img src="/" class="lazyload" data-src="http://note.youdao.com/yws/res/30735/WEBRESOURCEc995b74fb0b97d3981241c7315d18d68"  alt="image"></p>
<p>流程中主要处理以下几个事情：</p>
<ol>
<li>执行 <code>just</code> 操作符对发送数据进行被观察者对象包装<code>ObservableFromArray</code></li>
<li>执行 <code>subscribe</code> 对订阅者的订阅事件（onNext）进行订阅者包装，产生<code>LambdaObserver</code></li>
<li>执行 <code>ObservableFromArray</code> 被观察者实现的 <code>subscribeActual</code> 方法</li>
<li>创建 观察者所需要的参数<code>Disposable</code>，<code>FromArrayDisposable</code> 对象</li>
<li>调用观察者<code>LambdaObserver</code>的<code>onSubscribe</code>开始触发<code>onNext</code>、<code>onComplete</code>、<code>onError</code>响应</li>
</ol>
<p>这里面涉及几个主要对象：</p>
<ul>
<li>ObservableSource <code>被观察者数据源，负责观察者数据源的接收和处理</code></li>
<li>Obsrvable <code>ObservableSource 实现抽象类，启动入口，提供了大量操作符</code></li>
<li>Observer <code>观察者，负责处理</code></li>
<li>Disposable <code>作为信号器，用于对执行过程进行中断监控</code></li>
</ul>
<p>大致如图关系：</p>
<p><img src="/" class="lazyload" data-src="http://note.youdao.com/yws/res/30802/4D90E7BA835C40948788AB64B7A1C566"  alt="image"></p>
<h1 id="简单自定义操作"><a href="#简单自定义操作" class="headerlink" title="简单自定义操作"></a>简单自定义操作</h1><p>通过以上流程可以大概了解 RxJava 的运行流程和原理，因此后面我们需要做的是从里面找到我们合适的hook处理时机，以实现我们的要求。</p>
<h2 id="以Map为例子"><a href="#以Map为例子" class="headerlink" title="以Map为例子"></a>以Map为例子</h2><p>Map 操作是将一个输入源 转为另一种类型的数据并下发。</p>
<p>因此我们需要考虑在获得上一个输入类型的处理数据后，通过转化函数，再次进行转化类型的订阅者发送。<br>明白需求我们可以选择在<code>onNext</code>每次获得结果数据后进行依次转化并发送给新的 <code>Observer</code>，具体实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; source 为上一个数据源，map为转化函数，由于结果目的并不是要获取原始数据 S，因此只需要提供 T类型观察者就行</span><br><span class="line">class MapObservable&lt;S,T&gt;(private val source: ObservableSource&lt;S&gt;, val map: Function&lt;S, T&gt;) : Observable&lt;T&gt;() &#123;</span><br><span class="line">    override fun subscribeActual(observer: Observer&lt;in T&gt;?) &#123;</span><br><span class="line">    </span><br><span class="line">        &#x2F;&#x2F; 对原始被观察者进行观察，当发生新数据产生，则将数据通过指定的转化函数&#96;map&#96;进行转化后</span><br><span class="line">        &#x2F;&#x2F; 转发给目标类型T的观察者对象。</span><br><span class="line">        source.subscribe(object: Observer&lt;S&gt; &#123;</span><br><span class="line">            override fun onComplete() &#123;</span><br><span class="line">                observer?.onComplete()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            override fun onSubscribe(d: Disposable?) &#123;</span><br><span class="line">                observer?.onSubscribe(d)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            override fun onNext(t: S) &#123;</span><br><span class="line">                val t &#x3D; map.apply(t)</span><br><span class="line">                observer?.onNext(t)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            override fun onError(e: Throwable?) &#123;</span><br><span class="line">                observer?.onError(e)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="自定义协程操作"><a href="#自定义协程操作" class="headerlink" title="自定义协程操作"></a>自定义协程操作</h2><p>RxJava 中 <code>subscribeOn</code> 和 <code>observeOn</code> 也是一个异步操作符，分别对于为<code>ObservableSubscribeOn</code>、<code>ObservableObserveOn</code>，以它们为参考，可以先看下它们的实现。</p>
<h3 id="sbscribeOn"><a href="#sbscribeOn" class="headerlink" title="sbscribeOn"></a>sbscribeOn</h3><p><code>ObservableSubscribeOn</code> 在<code>subscribeActual</code>中只主要做一件事件，将<code>Observable.subscribe</code>订阅操作延迟到线程中执行，这样对于所有之前的包装的被观察者<code>Observable.subscribe</code> 和向下传递的<code>Observer</code> 行为都会在线程中该线程中执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public final class ObservableSubscribeOn&lt;T&gt; extends AbstractObservableWithUpstream&lt;T, T&gt; &#123;</span><br><span class="line">    ...</span><br><span class="line">    public void subscribeActual(final Observer&lt;? super T&gt; observer) &#123;</span><br><span class="line">        final SubscribeOnObserver&lt;T&gt; parent &#x3D; new SubscribeOnObserver&lt;&gt;(observer);</span><br><span class="line"></span><br><span class="line">        observer.onSubscribe(parent);</span><br><span class="line">        &#x2F;&#x2F; 设置目标 Disposable</span><br><span class="line">        parent.setDisposable(scheduler.scheduleDirect(new SubscribeTask(parent)));</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    static final class SubscribeOnObserver&lt;T&gt; extends AtomicReference&lt;Disposable&gt; implements Observer&lt;T&gt;, Disposable &#123;</span><br><span class="line"></span><br><span class="line">        private static final long serialVersionUID &#x3D; 8094547886072529208L;</span><br><span class="line">        final Observer&lt;? super T&gt; downstream;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 上游终止标记</span><br><span class="line">        final AtomicReference&lt;Disposable&gt; upstream;</span><br><span class="line"></span><br><span class="line">        SubscribeOnObserver(Observer&lt;? super T&gt; downstream) &#123;</span><br><span class="line">            this.downstream &#x3D; downstream;</span><br><span class="line">            this.upstream &#x3D; new AtomicReference&lt;&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onSubscribe(Disposable d) &#123;</span><br><span class="line">            &#x2F;&#x2F; 校验是需要执行 disposable 操作</span><br><span class="line">            DisposableHelper.setOnce(this.upstream, d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 终止标记</span><br><span class="line">        @Override</span><br><span class="line">        public void dispose() &#123;</span><br><span class="line">            &#x2F;&#x2F; 标记上游终止</span><br><span class="line">            DisposableHelper.dispose(upstream);</span><br><span class="line">            &#x2F;&#x2F; 标记自身终止</span><br><span class="line">            DisposableHelper.dispose(this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public boolean isDisposed() &#123;</span><br><span class="line">            &#x2F;&#x2F; 返回当前是否被设置终止标记</span><br><span class="line">            return DisposableHelper.isDisposed(get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        void setDisposable(Disposable d) &#123;</span><br><span class="line">            DisposableHelper.setOnce(this, d);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Runable包装需要执行是 source.subscribe ，将订阅操作指定到线程中执行。</span><br><span class="line">    final class SubscribeTask implements Runnable &#123;</span><br><span class="line">        private final SubscribeOnObserver&lt;T&gt; parent;</span><br><span class="line"></span><br><span class="line">        SubscribeTask(SubscribeOnObserver&lt;T&gt; parent) &#123;</span><br><span class="line">            this.parent &#x3D; parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void run() &#123;</span><br><span class="line">            source.subscribe(parent);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>异步操作符需要注意：</p>
<ol>
<li>Disposable 的处理</li>
<li>明确异步的执行操作及其其他动作线程所属的影响</li>
</ol>
<p>下面自定义一个 Looper 操作符，用于指定设定前的线程执行环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">class LooperOnObservable&lt;T&gt;(private val source: ObservableSource&lt;T&gt;, private val looper: Looper) : Observable&lt;T&gt;() &#123;</span><br><span class="line">    override fun subscribeActual(observer: Observer&lt;in T&gt;?) &#123;</span><br><span class="line">        Handler(looper).post(LooperObserver(observer))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 创建这个任务只是为了做为 Runnable 载体，并且在等待执行阶段，提供能被取消的能力</span><br><span class="line">    private inner class LooperObserver(val observer: Observer&lt;in T&gt;?): AtomicReference&lt;Disposable&gt;(), Observer&lt;T&gt; , Disposable, Runnable&#123;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 上游中断标识</span><br><span class="line">        private val upstream &#x3D; AtomicReference&lt;Disposable&gt;()</span><br><span class="line">        override fun onComplete() &#123;</span><br><span class="line">            observer?.onComplete()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun onSubscribe(d: Disposable?) &#123;</span><br><span class="line">            &#x2F;&#x2F; 如果当前已经被Disposable 所终止，那么通知上游终止</span><br><span class="line">            DisposableHelper.setOnce(this.upstream, d);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun onNext(t: T) &#123;</span><br><span class="line">            observer?.onNext(t)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun onError(e: Throwable?) &#123;</span><br><span class="line">           observer?.onError(e)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun isDisposed(): Boolean &#123;</span><br><span class="line">            return DisposableHelper.isDisposed(get());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun dispose() &#123;</span><br><span class="line">            &#x2F;&#x2F; 标记上游中断</span><br><span class="line">            DisposableHelper.dispose(upstream);</span><br><span class="line">            &#x2F;&#x2F; 标记自身中断</span><br><span class="line">            DisposableHelper.dispose(this);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        override fun run() &#123;</span><br><span class="line">            source.subscribe(observer)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fun &lt;T&gt; ObservableSource&lt;T&gt;.looperOn(looper: Looper): Observable&lt;T&gt; &#123;</span><br><span class="line">    return LooperOnObservable&lt;T&gt;(this, looper)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">val thread &#x3D; HandlerThread(&quot;Handler Thread &quot;)</span><br><span class="line">thread.start()</span><br><span class="line">Observable.just(1,2,3).map &#123;</span><br><span class="line">    Log.i(&quot;Log&quot;, &quot; Map 1 index[ $it ] in $&#123;Thread.currentThread()&#125; &quot;)</span><br><span class="line">    return@map it</span><br><span class="line">&#125;</span><br><span class="line">    .map &#123;</span><br><span class="line">        Log.i(&quot;Log&quot;, &quot;Map 2 index[ $it ] in $&#123;Thread.currentThread()&#125; &quot;)</span><br><span class="line">        return@map it</span><br><span class="line">    &#125;</span><br><span class="line">    .looperOn(thread.looper)</span><br><span class="line">    .subscribe &#123;</span><br><span class="line">        Log.i(&quot;Log&quot;, &quot;Next index[ $it ] in $&#123;Thread.currentThread()&#125; &quot;)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Map 1 index[ 1 ] in Thread[Handler Thread ,5,main] </span><br><span class="line">Map 2 index[ 1 ] in Thread[Handler Thread ,5,main] </span><br><span class="line">Next index[ 1 ] in Thread[Handler Thread ,5,main] </span><br><span class="line">Map 1 index[ 2 ] in Thread[Handler Thread ,5,main] </span><br><span class="line">Map 2 index[ 2 ] in Thread[Handler Thread ,5,main] </span><br><span class="line">Next index[ 2 ] in Thread[Handler Thread ,5,main] </span><br><span class="line">Map 1 index[ 3 ] in Thread[Handler Thread ,5,main] </span><br><span class="line">Map 2 index[ 3 ] in Thread[Handler Thread ,5,main] </span><br><span class="line">Next index[ 3 ] in Thread[Handler Thread ,5,main]</span><br></pre></td></tr></table></figure></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/RxJava/">RxJava</a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/11/28/BUG-Paging%E6%A1%86%E6%9E%B6PageListAdapter%E4%B8%8EBaseRecyclerViewAdapterHelper%E6%A1%86%E6%9E%B6BaseQuickAdapter%E5%86%B2%E7%AA%81/"><img class="prev_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">BUG-Paging框架PageListAdapter与BaseRecyclerViewAdapterHelper框架BaseQuickAdapter冲突</div></div></a></div><div class="next-post pull_right"><a href="/2019/06/24/Glide-%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Glide-缓存机制</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/01/13/Android源码编译和阅读/" title="Android源码编译和阅读"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-01-13</div><div class="relatedPosts_title">Android源码编译和阅读</div></div></a></div><div class="relatedPosts_item"><a href="/2016/05/15/Android未捕获异常处理/" title="Android 未捕获异常处理"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2016-05-15</div><div class="relatedPosts_title">Android 未捕获异常处理</div></div></a></div><div class="relatedPosts_item"><a href="/2019/02/14/Jetpack-Lifecycle/" title="Jetpack-Lifecycle"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-02-14</div><div class="relatedPosts_title">Jetpack-Lifecycle</div></div></a></div><div class="relatedPosts_item"><a href="/2018/03/03/Repo操作/" title="Repo操作"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-03-03</div><div class="relatedPosts_title">Repo操作</div></div></a></div><div class="relatedPosts_item"><a href="/2016/05/10/Handler学习小记/" title="Handler学习小记"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2016-05-10</div><div class="relatedPosts_title">Handler学习小记</div></div></a></div><div class="relatedPosts_item"><a href="/2018/06/09/Transform的基本应用/" title="Transform的基本应用"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-06-09</div><div class="relatedPosts_title">Transform的基本应用</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2014 - 2020 By Bevis</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>