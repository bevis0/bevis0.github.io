<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Jetpack-Lifecycle | Bevis技术小站</title><meta name="description" content="Jetpack-Lifecycle"><meta name="keywords" content="Android,Jetpack"><meta name="author" content="Bevis"><meta name="copyright" content="Bevis"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Jetpack-Lifecycle"><meta name="twitter:description" content="Jetpack-Lifecycle"><meta name="twitter:image" content="http://yoursite.com/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Jetpack-Lifecycle"><meta property="og:url" content="http://yoursite.com/2019/02/14/Jetpack-Lifecycle/"><meta property="og:site_name" content="Bevis技术小站"><meta property="og:description" content="Jetpack-Lifecycle"><meta property="og:image" content="http://yoursite.com/img/post.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://yoursite.com/2019/02/14/Jetpack-Lifecycle/"><link rel="prev" title="OkHttp" href="http://yoursite.com/2019/05/01/OkHttp/"><link rel="next" title="Android源码编译和阅读" href="http://yoursite.com/2019/01/13/Android%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%92%8C%E9%98%85%E8%AF%BB/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Bevis技术小站" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">17</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">12</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">6</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、配置"><span class="toc-number">1.</span> <span class="toc-text">一、配置</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、基本组成"><span class="toc-number">2.</span> <span class="toc-text">二、基本组成</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、基本使用"><span class="toc-number">3.</span> <span class="toc-text">三、基本使用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、原理初析"><span class="toc-number">4.</span> <span class="toc-text">四、原理初析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#注册与包装-Observer"><span class="toc-number">4.1.</span> <span class="toc-text">注册与包装 Observer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、相关传送门"><span class="toc-number">5.</span> <span class="toc-text">三、相关传送门</span></a></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Bevis技术小站</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Jetpack-Lifecycle</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2019-02-14 23:32:35"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2019-02-14</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Android/">Android</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><p>Lifecycle 是 Jetpack 的一套生命周期监控框架，目的是用于对进程、 Activity 和 Fragment 生命周期感知。</p>
<p>方便开发者在一些开发细节上对生命周期的感知强化，比如防止内存泄露、内存控制、周期性任务等情况，比较出名的方案是 Glide 对于<code>Request</code> 自实现的一套管理方案，目前有了这套官方的支持，就不在需要处理注册通知、以及观察者销毁等事宜。</p>
<h1 id="一、配置"><a href="#一、配置" class="headerlink" title="一、配置"></a>一、配置</h1><p>基于androidX项目的Gradle依赖配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    def lifecycle_version &#x3D; &quot;2.2.0&quot;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; ktx 包是对 androidx.lifecycle:lifecycle-runtime:2.2.0  包kotlin方面的增强，如果不需要kotlin 可以换回该包</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-runtime-ktx:$lifecycle_version&quot;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 如果使用的是java8 ，可以用该扩展包进行接口监听</span><br><span class="line">    implementation &quot;androidx.lifecycle:lifecycle-common-java8:$lifecycle_version&quot;</span><br><span class="line"></span><br><span class="line">    kapt &quot;androidx.lifecycle:lifecycle-compiler:$lifecycle_version&quot; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>lifecycle-extensions 依赖已经在2.2.0过期不再使用</code></p>
<ul>
<li>lifecycle-runtime-ktx 依赖关系</li>
</ul>
<p><img src="/" class="lazyload" data-src="http://note.youdao.com/yws/res/27283/WEBRESOURCE4b53087605cb1000c78ac8d8d259984e"  alt="image.png"></p>
<p>lifecycle-runtime-ktx 的 maven 依赖关系上，编译时已经包含：</p>
<ul>
<li>androidx.lifecycle:lifecycle-runtime:2.2.0</li>
<li>org.jetbrains.kotlinx:kotlinx-coroutines-android:1.3.0 (协程)</li>
</ul>
<h1 id="二、基本组成"><a href="#二、基本组成" class="headerlink" title="二、基本组成"></a>二、基本组成</h1><p><code>Lifecycle</code> 主要包括几个主要结构：</p>
<ul>
<li><p>LifecycleOwner <code>生命周期被观察者，主要被 AppCompatActivity、Fragment、LifecycleService 等需要被监控的目标类上实现，目前在androidX组件、aac 组件里面基本默认实现</code></p>
</li>
<li><p>LifecycleObserver <code>观察者接口，默认空实现，根据所提供的不同生命周期进行不同的接口（目前是Fragment 和 Activity），比如 FullLifecycleObserver 提供了Activity的生命周期监控，目前android主要提供两种观察者 LifecycleEventObserver 和 FullLifecycleObserver,</code></p>
</li>
<li><p>Lifecycle <code>提供观察者对被观察者的注册、注销、状态反馈，由 LifecycleOwner 提供</code></p>
</li>
<li><p>LifecycleRegistry <code>Lifecycle实现的子类，是观察者注册器，对LifecycleObserver进行注册、注销相关动作</code></p>
</li>
</ul>
<h1 id="三、基本使用"><a href="#三、基本使用" class="headerlink" title="三、基本使用"></a>三、基本使用</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">class MainActivity : AppCompatActivity() &#123;</span><br><span class="line">    private val presenter by lazy &#123;</span><br><span class="line">        MainPresenter()</span><br><span class="line">    &#125;</span><br><span class="line">    override fun onCreate(savedInstanceState: Bundle?) &#123;</span><br><span class="line">        super.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        lifecycle.addObserver(presenter)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class MainPresenter: DefaultLifecycleObserver &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>androidX 依赖的 <code>AppCompatActivity</code>、<code>Fragment</code> 默认都实现了 <code>LifecycleOwner</code> 接口，通过<code>getLifecycle</code>获取注册器进行注册。</p>
<p>对于观察者，还可以通过注解形式实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class MainPresenter: LifecycleObserver &#123;</span><br><span class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_CREATE)</span><br><span class="line">    fun onCreate() &#123;</span><br><span class="line">        Log.e(&quot;bevis&quot;, &quot;onCreate&quot;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @OnLifecycleEvent(Lifecycle.Event.ON_RESUME)</span><br><span class="line">    fun onResume() &#123;</span><br><span class="line">        Log.e(&quot;bevis&quot;, &quot;onResume&quot;)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="四、原理初析"><a href="#四、原理初析" class="headerlink" title="四、原理初析"></a>四、原理初析</h1><p>Lifecycle 框架是个典型的观察者框架，只是这种模式被官方默认支持。</p>
<h2 id="注册与包装-Observer"><a href="#注册与包装-Observer" class="headerlink" title="注册与包装 Observer"></a>注册与包装 Observer</h2><p><img src="/" class="lazyload" data-src="http://note.youdao.com/yws/res/27659/WEBRESOURCE448a5de37537f1150ef966f3527a1412"  alt="image.png"></p>
<p>整个流程主要集中在 <code>addObserver</code> 方法中，这边具体分析下这流程：</p>
<ul>
<li>将观察者构造为 ObserverWithState，并初始化状态（INITIALIZED 或 DESTROYED）</li>
<li>根据观察者的实现，生成不同的适配器。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FullLifecycleObserverAdapter 适用于 FullLifecycleObserver</span><br><span class="line"></span><br><span class="line">SingleGeneratedAdapterObserver</span><br><span class="line"></span><br><span class="line">CompositeGeneratedAdaptersObserver</span><br><span class="line"></span><br><span class="line">ReflectiveGenericLifecycleObserver</span><br></pre></td></tr></table></figure></li>
<li>更新新添加观察者的状态，直到和被观察者状态保持 一致。<ul>
<li>如果添加观察者时，它的状态滞后于被观察者，则会将所有未经过的状态执行一遍，比如当前Activity 状态为 onResume，则观察者会将 onCreate -&gt; onStart -&gt; onResume 都执行一遍。</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line">public class LifecycleRegistry extends Lifecycle &#123;</span><br><span class="line">    ...</span><br><span class="line">    public void addObserver(@NonNull LifecycleObserver observer) &#123;</span><br><span class="line">        &#x2F;&#x2F; 检查当前被观察者是否处于 DESTROYED ，如果是先初始化值为 </span><br><span class="line">        &#x2F;&#x2F; DESTROYED 否则 INITIALIZED</span><br><span class="line">        State initialState &#x3D; mState &#x3D;&#x3D; DESTROYED ? DESTROYED : INITIALIZED;</span><br><span class="line">        &#x2F;&#x2F; 初始化观察者包装类，该包装类有观察者对象和当前观察者感知到的状态 &#x2F;&#x2F; 值。</span><br><span class="line">        ObserverWithState statefulObserver &#x3D; new ObserverWithState(observer, initialState);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 缓存到索引中</span><br><span class="line">        ObserverWithState previous &#x3D; mObserverMap.putIfAbsent(observer, statefulObserver);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 如果之前已经添加过则不重新进行后续的初始化</span><br><span class="line">        if (previous !&#x3D; null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 这是个弱引用，如果被观察者销毁了，则会返回null，那么久不进行</span><br><span class="line">        &#x2F;&#x2F; 后续的流程</span><br><span class="line">        LifecycleOwner lifecycleOwner &#x3D; mLifecycleOwner.get();</span><br><span class="line">        if (lifecycleOwner &#x3D;&#x3D; null) &#123;</span><br><span class="line">            &#x2F;&#x2F; it is null we should be destroyed. Fallback quickly</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 如果当前其他的观察者处于状态更新中（sync()执行中）或者</span><br><span class="line">        &#x2F;&#x2F; 当前正在添加的观察者（添加事务还没执行完）不为空，则在完成当前对象添加后重新更新状态(sync())</span><br><span class="line">        boolean isReentrance &#x3D; mAddingObserverCounter !&#x3D; 0 || mHandlingEvent;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 获得当前实际被观察者状态</span><br><span class="line">        State targetState &#x3D; calculateTargetState(observer);</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 标记正在执行添加事务流程的标记位</span><br><span class="line">        mAddingObserverCounter++;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 如果观察者状态比目标状态低，则将状态一级一级递增，并在递增过程中</span><br><span class="line">        &#x2F;&#x2F; 通知新添加的观察者状态变更</span><br><span class="line">        while ((statefulObserver.mState.compareTo(targetState) &lt; 0</span><br><span class="line">                &amp;&amp; mObserverMap.contains(observer))) &#123;</span><br><span class="line">            pushParentState(statefulObserver.mState);</span><br><span class="line">            statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));</span><br><span class="line">            popParentState();</span><br><span class="line">            &#x2F;&#x2F; 为了防止更新过程中被观察者状态已经变更，则重新更新目标状态</span><br><span class="line">            targetState &#x3D; calculateTargetState(observer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 更新所有被观察者状态</span><br><span class="line">        if (!isReentrance) &#123;</span><br><span class="line">            &#x2F;&#x2F; we do sync only on the top level.</span><br><span class="line">            sync();</span><br><span class="line">        &#125;</span><br><span class="line">        mAddingObserverCounter--;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    private State calculateTargetState(LifecycleObserver observer) &#123;</span><br><span class="line">        Entry&lt;LifecycleObserver, ObserverWithState&gt; previous &#x3D; mObserverMap.ceil(observer);</span><br><span class="line"></span><br><span class="line">        State siblingState &#x3D; previous !&#x3D; null ? previous.getValue().mState : null;</span><br><span class="line">        State parentState &#x3D; !mParentStates.isEmpty() ? mParentStates.get(mParentStates.size() - 1)</span><br><span class="line">                : null;</span><br><span class="line">        return min(min(mState, siblingState), parentState);</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    static class ObserverWithState &#123;</span><br><span class="line">        State mState;</span><br><span class="line">        LifecycleEventObserver mLifecycleObserver;</span><br><span class="line"></span><br><span class="line">        ObserverWithState(LifecycleObserver observer, State initialState) &#123;</span><br><span class="line">            mLifecycleObserver &#x3D; Lifecycling.lifecycleEventObserver(observer);</span><br><span class="line">            mState &#x3D; initialState;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        void dispatchEvent(LifecycleOwner owner, Event event) &#123;</span><br><span class="line">            State newState &#x3D; getStateAfter(event);</span><br><span class="line">            mState &#x3D; min(mState, newState);</span><br><span class="line">            mLifecycleObserver.onStateChanged(owner, event);</span><br><span class="line">            mState &#x3D; newState;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line">public class Lifecycling &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#x2F;&#x2F; 该方法是根据观察者生成对应的包装装饰器   </span><br><span class="line">    static LifecycleEventObserver lifecycleEventObserver(Object object) &#123;</span><br><span class="line">        boolean isLifecycleEventObserver &#x3D; object instanceof LifecycleEventObserver;</span><br><span class="line">        boolean isFullLifecycleObserver &#x3D; object instanceof FullLifecycleObserver;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; FullLifecycleObserver 及其子类都是用  </span><br><span class="line">        &#x2F;&#x2F; FullLifecycleObserverAdapter 包装</span><br><span class="line">        if (isLifecycleEventObserver &amp;&amp; isFullLifecycleObserver) &#123;</span><br><span class="line">            return new FullLifecycleObserverAdapter((FullLifecycleObserver) object,</span><br><span class="line">                    (LifecycleEventObserver) object);</span><br><span class="line">        &#125;</span><br><span class="line">        if (isFullLifecycleObserver) &#123;</span><br><span class="line">            return new FullLifecycleObserverAdapter((FullLifecycleObserver) object, null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; LifecycleEventObserver 及其子类</span><br><span class="line">        if (isLifecycleEventObserver) &#123;</span><br><span class="line">            return (LifecycleEventObserver) object;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 对于不是规范性的观察者，比如 </span><br><span class="line">        &#x2F;&#x2F; OnLifecycleEvent注解、APT生成对象或者 直接实现于 </span><br><span class="line">        &#x2F;&#x2F; LifecycleObserver的观察者</span><br><span class="line">        final Class&lt;?&gt; klass &#x3D; object.getClass();</span><br><span class="line">        int type &#x3D; getObserverConstructorType(klass);</span><br><span class="line">        &#x2F;&#x2F; 返回构造的类型</span><br><span class="line">        if (type &#x3D;&#x3D; GENERATED_CALLBACK) &#123;</span><br><span class="line">            List&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt; constructors &#x3D;</span><br><span class="line">                    sClassToAdapters.get(klass);</span><br><span class="line">            if (constructors.size() &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                GeneratedAdapter generatedAdapter &#x3D; createGeneratedAdapter(</span><br><span class="line">                        constructors.get(0), object);</span><br><span class="line">                return new SingleGeneratedAdapterObserver(generatedAdapter);</span><br><span class="line">            &#125;</span><br><span class="line">            GeneratedAdapter[] adapters &#x3D; new GeneratedAdapter[constructors.size()];</span><br><span class="line">            for (int i &#x3D; 0; i &lt; constructors.size(); i++) &#123;</span><br><span class="line">                adapters[i] &#x3D; createGeneratedAdapter(constructors.get(i), object);</span><br><span class="line">            &#125;</span><br><span class="line">            return new CompositeGeneratedAdaptersObserver(adapters);</span><br><span class="line">        &#125;</span><br><span class="line">        return new ReflectiveGenericLifecycleObserver(object);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    private static int getObserverConstructorType(Class&lt;?&gt; klass) &#123;</span><br><span class="line">        &#x2F;&#x2F; 先从缓存里面获取CallbackType，没有在进行解析</span><br><span class="line">        Integer callbackCache &#x3D; sCallbackCache.get(klass);</span><br><span class="line">        if (callbackCache !&#x3D; null) &#123;</span><br><span class="line">            return callbackCache;</span><br><span class="line">        &#125;</span><br><span class="line">        int type &#x3D; resolveObserverCallbackType(klass);</span><br><span class="line">        sCallbackCache.put(klass, type);</span><br><span class="line">        return type;</span><br><span class="line">    &#125;   </span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; 解析目标类对观察者类</span><br><span class="line">    private static int resolveObserverCallbackType(Class&lt;?&gt; klass) &#123;</span><br><span class="line">        &#x2F;&#x2F; 判断是否是反射类型</span><br><span class="line">        if (klass.getCanonicalName() &#x3D;&#x3D; null) &#123;</span><br><span class="line">            return REFLECTIVE_CALLBACK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 如果是由APT </span><br><span class="line">        &#x2F;&#x2F; &quot;androidx.lifecycle:lifecycle-compiler:2.2.0&quot;生成的xxx_Lifecycle</span><br><span class="line">        &#x2F;&#x2F; Adapter的类，则根据规范生成构造器信息，并存到</span><br><span class="line">        &#x2F;&#x2F; sClassToAdapters 备用</span><br><span class="line">        Constructor&lt;? extends GeneratedAdapter&gt; constructor &#x3D; generatedConstructor(klass);</span><br><span class="line">        if (constructor !&#x3D; null) &#123;</span><br><span class="line">            sClassToAdapters.put(klass, Collections</span><br><span class="line">                    .&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt;singletonList(constructor));</span><br><span class="line">            return GENERATED_CALLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 检测类中是否包含有 OnLifecycleEvent 注解标记的方法，如果有则</span><br><span class="line">        &#x2F;&#x2F; 将给类callback type 标记为反射类型</span><br><span class="line">        boolean hasLifecycleMethods &#x3D; ClassesInfoCache.sInstance.hasLifecycleMethods(klass);</span><br><span class="line">        if (hasLifecycleMethods) &#123;</span><br><span class="line">            return REFLECTIVE_CALLBACK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; superclass &#x3D; klass.getSuperclass();</span><br><span class="line">        List&lt;Constructor&lt;? extends GeneratedAdapter&gt;&gt; adapterConstructors &#x3D; null;</span><br><span class="line">        &#x2F;&#x2F; 判断是否为继承自 LifecycleObserver 的子类</span><br><span class="line">        if (isLifecycleParent(superclass)) &#123;</span><br><span class="line">            if (getObserverConstructorType(superclass) &#x3D;&#x3D; REFLECTIVE_CALLBACK) &#123;</span><br><span class="line">                return REFLECTIVE_CALLBACK;</span><br><span class="line">            &#125;</span><br><span class="line">            adapterConstructors &#x3D; new ArrayList&lt;&gt;(sClassToAdapters.get(superclass));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 判断是否实现自 LifecycleObserver </span><br><span class="line">        &#x2F;&#x2F; 的子类，如果是判断当前类的构造方式</span><br><span class="line">        for (Class&lt;?&gt; intrface : klass.getInterfaces()) &#123;</span><br><span class="line">            if (!isLifecycleParent(intrface)) &#123;</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            if (getObserverConstructorType(intrface) &#x3D;&#x3D; REFLECTIVE_CALLBACK) &#123;</span><br><span class="line">                return REFLECTIVE_CALLBACK;</span><br><span class="line">            &#125;</span><br><span class="line">            if (adapterConstructors &#x3D;&#x3D; null) &#123;</span><br><span class="line">                adapterConstructors &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            adapterConstructors.addAll(sClassToAdapters.get(intrface));</span><br><span class="line">        &#125;</span><br><span class="line">        if (adapterConstructors !&#x3D; null) &#123;</span><br><span class="line">            sClassToAdapters.put(klass, adapterConstructors);</span><br><span class="line">            return GENERATED_CALLBACK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return REFLECTIVE_CALLBACK;</span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="三、相关传送门"><a href="#三、相关传送门" class="headerlink" title="三、相关传送门"></a>三、相关传送门</h1><p><a href="https://android.googlesource.com/platform/frameworks/support/+/androidx-master-dev" target="_blank" rel="noopener">AndroidX Google Git 项目地址</a></p>
<p><a href="https://developer.android.google.cn/jetpack/androidx/releases/lifecycle?hl=it" target="_blank" rel="noopener">Android Life 版本更新日志</a></p>
<p><a href="https://developer.android.google.cn/jetpack/docs/getting-started?hl=zh_cn" target="_blank" rel="noopener">Jetpack Google文档</a></p>
</div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a><a class="post-meta__tags" href="/tags/Jetpack/">Jetpack</a></div><div class="post_share"></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2019/05/01/OkHttp/"><img class="prev_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">OkHttp</div></div></a></div><div class="next-post pull_right"><a href="/2019/01/13/Android%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%92%8C%E9%98%85%E8%AF%BB/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Android源码编译和阅读</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/2019/05/01/OkHttp/" title="OkHttp"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-05-01</div><div class="relatedPosts_title">OkHttp</div></div></a></div><div class="relatedPosts_item"><a href="/2016/05/10/Handler学习小记/" title="Handler学习小记"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2016-05-10</div><div class="relatedPosts_title">Handler学习小记</div></div></a></div><div class="relatedPosts_item"><a href="/2016/05/15/Android未捕获异常处理/" title="Android 未捕获异常处理"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2016-05-15</div><div class="relatedPosts_title">Android 未捕获异常处理</div></div></a></div><div class="relatedPosts_item"><a href="/2018/06/09/Transform的基本应用/" title="Transform的基本应用"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-06-09</div><div class="relatedPosts_title">Transform的基本应用</div></div></a></div><div class="relatedPosts_item"><a href="/2018/03/03/Repo操作/" title="Repo操作"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2018-03-03</div><div class="relatedPosts_title">Repo操作</div></div></a></div><div class="relatedPosts_item"><a href="/2019/01/13/Android源码编译和阅读/" title="Android源码编译和阅读"><img class="relatedPosts_cover lazyload"data-src="/img/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2019-01-13</div><div class="relatedPosts_title">Android源码编译和阅读</div></div></a></div></div><div class="clear_both"></div></div></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2014 - 2020 By Bevis</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>